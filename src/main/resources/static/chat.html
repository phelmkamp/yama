<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="utf-8"/>
    <meta http-equiv="X-UA-Compatible" content="IE=edge"/>
    <title>honiara</title>
    <meta name="description" content=""/>
    <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"/>
    <base href="/"/>
    <link rel="stylesheet" type="text/css" href="/webjars/bootstrap/css/bootstrap.min.css"/>
	<link rel="stylesheet" href="css/bootstrap-theme.min.css">
</head>
<body onload="connect()">
<nav id="myNavbar" class="navbar navbar-default navbar-inverse navbar-static-top" role="navigation">
	<!-- Brand and toggle get grouped for better mobile display -->
	<div class="container">
		<div class="navbar-header">
			<button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#navbarCollapse">
				<span class="sr-only">Toggle navigation</span>
				<span class="icon-bar"></span>
				<span class="icon-bar"></span>
				<span class="icon-bar"></span>
			</button>
			<a class="navbar-brand" href="index.html">honiara</a>
		</div>
		<!-- Collect the nav links, forms, and other content for toggling -->
		<div class="collapse navbar-collapse" id="navbarCollapse">
			<ul class="nav navbar-nav">
				<li><a href="index.html"><span class="glyphicon glyphicon-home"></span> home</a></li>
				<li class="active"><a href="" onClick="return false;"><span class="glyphicon glyphicon-pencil"></span> chat</a></li>
				<li><a href="" onClick="return false;"><span class="glyphicon glyphicon-globe"></span> convos <span class="badge">3</span></a></li>
				<li><a href="" onClick="return false;"><span class="glyphicon glyphicon-user"></span> users <span class="badge">25</span></a></li>
			</ul>
		</div>
	</div>
</nav>
<div class="container">
	<form class="form-horizontal">
		<div class="form-group">
		    <label for="content" class="sr-only">chat here</label>
		    <div class="col-xs-12">
		        <input type="text" class="form-control" id="content" placeholder="chat here" onkeydown="sendContent();" onkeyup="sendContent();" />
		    </div>
		</div>
	</form>
    <div class="row">
    	<div id="stream1" class="col-xs-6">
    		<label>you</label>
    		<p id="response" class="text-muted" style="word-wrap: break-word;"></p>
    	</div>
    	<div id="stream2" class="col-xs-6">
    		<label>friend</label>
    		<p id="response2" class="text-primary" style="word-wrap: break-word;"></p>
    	</div>
	</div>
	<hr>
	<div class="row">
		<div class="col-xs-12">
			<footer>
				<p>&copy; copyright 2016 phil helmkamp</p>
			</footer>
		</div>
	</div>
</div>
<script type="text/javascript" src="/webjars/jquery/jquery.min.js"></script>
<script type="text/javascript" src="/webjars/bootstrap/js/bootstrap.min.js"></script>
<script src="sockjs-0.3.4.js"></script>
<script src="stomp.js"></script>
<script type="text/javascript">
	var stompClient = null;
	var id = null;
	var user = null;
	
	function setConnected(connected) {
	    
	}
	
	function connect() {        	
	    var socket = new SockJS('/honiara');
	    stompClient = Stomp.over(socket);
	    stompClient.connect({}, function(frame) {
	        setConnected(true);
	        console.log('Connected: ' + frame);
	        user = frame.headers['user-name'];
	        id = guid();
	        stompClient.subscribe('/topic/convos/*', function(message){
	        	showMessage2(JSON.parse(message.body));
	        }, { id: id });
	        console.log('ID: ' + id);
	    });
	}
	
	function guid() {
	  function s4() {
	    return Math.floor((1 + Math.random()) * 0x10000)
	      .toString(16)
	      .substring(1);
	  }
	  return s4() + s4() + '-' + s4() + '-' + s4() + '-' +
	    s4() + '-' + s4() + s4() + s4();
	}
	
	function disconnect() {
	    if (stompClient != null) {
	        stompClient.disconnect();
	    }
	    setConnected(false);
	    console.log("Disconnected");
	}
	
	function sendContent() {
	    var content = document.getElementById('content').value;
	    document.getElementById('content').value = '';
	    if (content.length > 0) {
	    	showMessage(content);
	    	stompClient.send("/app/honiara/convos/1", {}, JSON.stringify({ 'content': content }));
	    }
	}
	
	function showMessage(message) {
	    var response = document.getElementById('response');
	    response.appendChild(document.createTextNode(message));
	}
	
	function showMessage2(message) {
		if (message.sender == user) return;
		
	    var response = document.getElementById('response2');
	    response.appendChild(document.createTextNode(message.content));
	}
</script>
</body>
</html>
